<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск вопросов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; color: #343a40; }
        .container-narrow { max-width: 900px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .search-box { position: relative; margin-bottom: 30px; }
        .search-box .clear-btn { position: absolute; right: 50px; top: 50%; transform: translateY(-50%); border: none; background: none; color: #6c757d; cursor: pointer; }
        .search-box .search-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: none; color: #6c757d; cursor: pointer; }
        .question-item { margin-bottom: 25px; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; background-color: #fefefe; }
        .question-text { font-weight: 600; margin-bottom: 15px; color: #495057; }
        .answer-item { padding: 8px 12px; margin: 5px 0; border-radius: 5px; border: 1px solid #e9ecef; }
        .answer-item.correct { background-color: #d4edda; border-color: #c3e6cb; color: #155724; font-weight: 500; }
        .answer-item.incorrect { background-color: #f8f9fa; border-color: #e9ecef; color: #6c757d; }
        .no-results { text-align: center; padding: 40px; color: #6c757d; }
        .highlight { background-color: #fff3cd; padding: 2px 4px; border-radius: 3px; }
        .results-count { margin-bottom: 20px; color: #6c757d; font-size: 0.9rem; }
    </style>
    <link rel="preload" href="assets/js/data.js" as="script">
    <link rel="preload" href="assets/js/i18n.js" as="script">
    <link rel="preload" href="assets/js/ui.js" as="script">
</head>
<body>
    <div class="container-narrow">
        <div class="d-flex justify-content-between align-items-center mb-3">
    <script>
        (function(){
            try {
                if (typeof window === 'undefined') return;
                if (window.__QUIET_CONSOLE === undefined) window.__QUIET_CONSOLE = true;
                if (!window.__QUIET_CONSOLE) return;
                ['log','info','debug','warn'].forEach(function(m){ if (console && console[m]) { console['__'+m]=console[m]; console[m]=function(){}; } });
            } catch (e) {}
        })();
    </script>
            <div id="breadcrumbs"></div>
            <div id="backBtn"></div>
        </div>
        <h3 class="mb-4">Поиск вопросов</h3>
        
        <!-- Поисковая форма -->
        <div class="search-box">
            <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="Введите ключевые слова для поиска вопросов..." style="padding-right: 90px;">
            <button type="button" id="clearBtn" class="clear-btn" title="Очистить поиск" style="display: none;">
                <i class="fas fa-times"></i>
            </button>
            <button type="button" id="searchBtn" class="search-btn" title="Поиск">
                <i class="fas fa-search"></i>
            </button>
        </div>

        <!-- Счетчик результатов -->
        <div id="resultsCount" class="results-count" style="display: none;"></div>

        <!-- Результаты поиска -->
        <div id="searchResults"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/i18n.js"></script>
    <script src="assets/js/ui.js"></script>
    <script>
    let questions = [], answers = [];
    let allQuestions = [];
    let currentSearchResults = [];

    // Функция для нормализации текста (убираем диакритики и приводим к нижнему регистру)
    function normalizeText(text) {
        if (!text) return '';
        return text.toLowerCase()
            .replace(/[іїєґ]/g, (match) => {
                switch(match) {
                    case 'і': return 'и';
                    case 'ї': return 'и';
                    case 'є': return 'е';
                    case 'ґ': return 'г';
                    default: return match;
                }
            })
            .replace(/[^\u0400-\u04FF\u0041-\u005A\u0061-\u007A\u0030-\u0039\s]/g, '');
    }

    // Умный поиск по ключевым словам
    function searchQuestions(searchTerm) {
        if (!searchTerm.trim()) {
            return [];
        }

        const normalizedSearchTerm = normalizeText(searchTerm);
        const searchWords = normalizedSearchTerm.split(/\s+/).filter(word => word.length > 2);
        
        if (searchWords.length === 0) {
            return [];
        }

        const results = [];

        allQuestions.forEach(question => {
            const questionText = normalizeText(question._Question || '');
            const helpText = normalizeText(question._Help || '');
            
            let score = 0;
            const matchedWords = [];

            // Проверяем каждое слово поиска
            searchWords.forEach(searchWord => {
                // Точное совпадение в тексте вопроса (высокий приоритет)
                if (questionText.includes(searchWord)) {
                    score += 10;
                    matchedWords.push(searchWord);
                }
                
                // Частичное совпадение в тексте вопроса
                const questionWords = questionText.split(/\s+/);
                questionWords.forEach(word => {
                    if (word.includes(searchWord) && word.length > searchWord.length) {
                        score += 5;
                        if (!matchedWords.includes(searchWord)) {
                            matchedWords.push(searchWord);
                        }
                    }
                });

                // Поиск в справочной информации (низкий приоритет)
                if (helpText.includes(searchWord)) {
                    score += 2;
                    if (!matchedWords.includes(searchWord)) {
                        matchedWords.push(searchWord);
                    }
                }
            });

            // Бонус за количество найденных слов
            if (matchedWords.length === searchWords.length) {
                score += 20; // Все слова найдены
            } else if (matchedWords.length > 0) {
                score += matchedWords.length * 3; // Частичное совпадение
            }

            if (score > 0) {
                results.push({
                    question: question,
                    score: score,
                    matchedWords: matchedWords
                });
            }
        });

        // Сортируем по релевантности
        return results.sort((a, b) => b.score - a.score);
    }

    // Функция для подсветки найденных слов
    function highlightText(text, searchWords) {
        if (!text || !searchWords.length) return text;
        
        let highlightedText = text;
        searchWords.forEach(word => {
            const regex = new RegExp(`(${word})`, 'gi');
            highlightedText = highlightedText.replace(regex, '<span class="highlight">$1</span>');
        });
        
        return highlightedText;
    }

    // Отображение результатов поиска
    function displayResults(results, searchTerm) {
        const resultsContainer = document.getElementById('searchResults');
        const resultsCount = document.getElementById('resultsCount');
        
        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <h5>Совпадений не найдено</h5>
                    <p>Попробуйте изменить ключевые слова поиска</p>
                </div>
            `;
            resultsCount.style.display = 'none';
            return;
        }

        resultsCount.innerHTML = `Найдено вопросов: <strong>${results.length}</strong>`;
        resultsCount.style.display = 'block';

        const searchWords = normalizeText(searchTerm).split(/\s+/).filter(word => word.length > 2);
        
        let html = '';
        results.forEach((result, index) => {
            const question = result.question;
            const questionId = question._KodQuestion;
            
            // Получаем ответы для этого вопроса
            const questionAnswers = answers.filter(a => a._KodQuestion === questionId);
            
            // Подсвечиваем найденные слова в тексте вопроса
            const highlightedQuestion = highlightText(question._Question, searchWords);
            
            html += `
                <div class="question-item">
                    <div class="question-text">
                        Вопрос ${index + 1}: ${highlightedQuestion}
                    </div>
                    <div class="answers-section">
            `;
            
            questionAnswers.forEach((answer, answerIndex) => {
                const isCorrect = parseInt(answer._VesAnswer) > 0;
                const answerClass = isCorrect ? 'correct' : 'incorrect';
                const answerLetter = String.fromCharCode(65 + answerIndex); // A, B, C, D...
                
                html += `
                    <div class="answer-item ${answerClass}">
                        <strong>${answerLetter})</strong> ${answer._Answer}
                        ${isCorrect ? '<i class="fas fa-check-circle ms-2"></i>' : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        resultsContainer.innerHTML = html;
    }

    // Выполнение поиска
    function performSearch() {
        const searchTerm = document.getElementById('searchInput').value.trim();
        if (!searchTerm) {
            clearSearch();
            return;
        }
        
        const results = searchQuestions(searchTerm);
        currentSearchResults = results;
        displayResults(results, searchTerm);
        
        // Показываем кнопку очистки
        document.getElementById('clearBtn').style.display = 'block';
    }

    // Очистка поиска
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
        document.getElementById('resultsCount').style.display = 'none';
        document.getElementById('clearBtn').style.display = 'none';
        currentSearchResults = [];
    }

    // Загрузка данных из JSON файлов
    async function loadQuestionsAndAnswers() {
        try {
            const [questionsResponse, answersResponse] = await Promise.all([
                fetch('Quest3.json'),
                fetch('Answer3.json')
            ]);
            
            if (!questionsResponse.ok || !answersResponse.ok) {
                throw new Error('Ошибка загрузки данных');
            }
            
            const questionsData = await questionsResponse.json();
            const answersData = await answersResponse.json();
            
            allQuestions = questionsData.DATAPACKET.ROWDATA.ROW || [];
            answers = answersData.DATAPACKET.ROWDATA.ROW || [];
            
            try { if (window && window.__QUIET_CONSOLE === false) console.log(`Загружено ${allQuestions.length} вопросов и ${answers.length} ответов`); } catch (e) {}
            
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
            document.getElementById('searchResults').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Ошибка загрузки данных. Пожалуйста, обновите страницу.
                </div>
            `;
        }
    }

    // Инициализация страницы
    async function init() {
        // Настраиваем хлебные крошки и кнопку назад
        const crumbs = [
            { label: 'Главная', href: 'index.html' },
            { label: 'Поиск вопросов', href: 'stats.html' }
        ];
        
        if (window.uiHelpers) {
            uiHelpers.renderBreadcrumbs('breadcrumbs', crumbs);
            uiHelpers.renderBack('backBtn', 'index.html', 'Назад');
        }
        
        // Загружаем данные
        await loadQuestionsAndAnswers();
        
        // Настраиваем обработчики событий
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        
        // Поиск по Enter или клику на кнопку
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        searchBtn.addEventListener('click', performSearch);
        clearBtn.addEventListener('click', clearSearch);
        
        // Показать/скрыть кнопку очистки при изменении текста
        searchInput.addEventListener('input', (e) => {
            if (e.target.value.trim() === '') {
                clearSearch();
            }
        });
        
    try { if (window && window.__QUIET_CONSOLE === false) console.log('Страница поиска инициализирована'); } catch (e) {}
    }

    // Запуск инициализации
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>


