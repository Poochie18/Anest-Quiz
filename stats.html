<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="menu_stats">Статистика</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; color: #343a40; }
        .container-narrow { max-width: 900px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .cursor-pointer { cursor: pointer; }
        .theme-details { border-top: 1px solid #dee2e6; margin-top: 10px; padding-top: 10px; }
    </style>
    <link rel="preload" href="assets/js/data.js" as="script">
    <link rel="preload" href="assets/js/i18n.js" as="script">
    <link rel="preload" href="assets/js/ui.js" as="script">
</head>
<body>
    <div class="container-narrow">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div id="breadcrumbs"></div>
            <div id="backBtn"></div>
        </div>
        <h3 class="mb-3" data-i18n="stats_title">Статистика</h3>
        <div id="theme-stats"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/i18n.js"></script>
    <script src="assets/js/ui.js"></script>
    <script>
    let themes = [], answers = [];

    function showThemeDetails(themeId) {
        const stats = JSON.parse(localStorage.getItem('quizStats') || '{}');
        const theme = themes.find(t => t.id === themeId);
        const lastResults = JSON.parse(localStorage.getItem(`lastQuiz_${themeId}`) || '[]');
        const detailed = document.createElement('div');
        detailed.className = 'theme-details mt-2';
        if (lastResults.length === 0) {
            detailed.innerHTML = `<p class="text-muted">${window.i18n ? i18n.t('never') : 'Ніколи'}</p>`;
            return detailed;
        }
        detailed.innerHTML = `
            <h6 class="mb-2">${theme ? theme.name : ''}</h6>
            <div class="list-group">
                ${lastResults.map((r, i) => `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${(window.i18n? i18n.t('question_word') : 'Питання')} ${i + 1}</strong>
                            <span class="badge bg-${r.userScore === r.maxScore ? 'success' : 'danger'}">${r.userScore === r.maxScore ? (window.i18n? i18n.t('correct') : 'Вірно') : (window.i18n? i18n.t('incorrect') : 'Невірно')}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        return detailed;
    }

    function updateStatistics() {
        const stats = JSON.parse(localStorage.getItem('quizStats') || '{}');
        const container = document.getElementById('theme-stats');
        container.innerHTML = '';
        themes.forEach(theme => {
            const tStats = stats[theme.id] || { total: 0, correct: 0 };
            const percentage = tStats.total > 0 ? Math.round((tStats.correct / tStats.total) * 100) : 0;
            const lastAttemptDate = tStats.lastAttempt ? new Date(tStats.lastAttempt).toLocaleDateString() : (window.i18n? i18n.t('never') : 'Ніколи');
            const div = document.createElement('div');
            div.className = 'mb-3';
            div.innerHTML = `
                <div class="theme-header cursor-pointer" onclick="this.parentElement.querySelector('.theme-details').classList.toggle('d-none')">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div>
                            <strong>${theme.name}</strong>
                            <small class="text-muted ms-2">${window.i18n? i18n.t('last_attempt') : 'Остання спроба'}: ${lastAttemptDate}</small>
                        </div>
                        <span class="badge bg-${percentage >= 70 ? 'success' : percentage >= 40 ? 'warning' : 'danger'}">${percentage}% (${tStats.correct}/${tStats.total})</span>
                    </div>
                    <div class="progress" style="height:8px;">
                        <div class="progress-bar bg-${percentage >= 70 ? 'success' : percentage >= 40 ? 'warning' : 'danger'}" style="width:${percentage}%"></div>
                    </div>
                </div>
            `;
            const details = showThemeDetails(theme.id);
            details.classList.add('d-none');
            div.appendChild(details);
            container.appendChild(div);
        });
    }

    async function init() {
        if (window.quizData) {
            const loaded = await quizData.load();
            themes = loaded.themes; answers = loaded.answers;
        }
        const crumbs = [
            { label: (window.i18n? i18n.t('breadcrumbs_home') : 'Головна'), i18nKey: 'breadcrumbs_home', href: 'index.html' },
            { label: (window.i18n? i18n.t('breadcrumbs_stats') : 'Статистика'), i18nKey: 'breadcrumbs_stats', href: 'stats.html' }
        ];
        if (window.uiHelpers) {
            uiHelpers.renderBreadcrumbs('breadcrumbs', crumbs);
            uiHelpers.renderBack('backBtn', 'index.html', (window.i18n? i18n.t('back') : 'Назад'));
        }
        updateStatistics();
    }

    init();
    </script>
</body>
</html>


