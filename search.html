<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск вопросов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: ''Segoe UI'', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; color: #343a40; }
        .container-narrow { max-width: 900px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .search-box { position: relative; margin-bottom: 30px; }
        .search-box .clear-btn { position: absolute; right: 50px; top: 50%; transform: translateY(-50%); border: none; background: none; color: #6c757d; cursor: pointer; }
        .search-box .search-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: none; color: #6c757d; cursor: pointer; }
        .question-item { margin-bottom: 25px; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; background-color: #fefefe; }
        .question-text { font-weight: 600; margin-bottom: 15px; color: #495057; }
        .answer-item { padding: 8px 12px; margin: 5px 0; border-radius: 5px; border: 1px solid #e9ecef; }
        .answer-item.correct { background-color: #d4edda; border-color: #c3e6cb; color: #155724; font-weight: 500; }
        .answer-item.incorrect { background-color: #f8f9fa; border-color: #e9ecef; color: #6c757d; }
        .no-results { text-align: center; padding: 40px; color: #6c757d; }
        .highlight { background-color: #ffeb3b; padding: 2px 4px; border-radius: 3px; font-weight: 600; color: #333; }
        .results-count { margin-bottom: 20px; color: #6c757d; font-size: 0.9rem; }
    </style>
    <link rel="preload" href="assets/js/data.js" as="script">
    <link rel="preload" href="assets/js/i18n.js" as="script">
    <link rel="preload" href="assets/js/ui.js" as="script">
</head>
<body>
    <div class="container-narrow">
        <div class="d-flex justify-content-between align-items-center mb-3">
    <script>
        (function(){
            try {
                if (typeof window === 'undefined') return;
                if (window.__QUIET_CONSOLE === undefined) window.__QUIET_CONSOLE = true;
                if (!window.__QUIET_CONSOLE) return;
                ['log','info','debug','warn'].forEach(function(m){ if (console && console[m]) { console['__'+m]=console[m]; console[m]=function(){}; } });
            } catch (e) {}
        })();
    </script>
            <div id="breadcrumbs"></div>
            <div id="backBtn"></div>
        </div>
        <h3 class="mb-4">Поиск вопросов</h3>
        
        <div class="search-box">
            <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="Введите ключевые слова для поиска вопросов..." style="padding-right: 90px;">
            <button type="button" id="clearBtn" class="clear-btn" title="Очистить поиск" style="display: none;">
                <i class="fas fa-times"></i>
            </button>
            <button type="button" id="searchBtn" class="search-btn" title="Поиск">
                <i class="fas fa-search"></i>
            </button>
        </div>

        <div id="resultsCount" class="results-count" style="display: none;"></div>
        <div id="searchResults"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/i18n.js"></script>
    <script src="assets/js/ui.js"></script>
    <script>
    let questions = [], answers = [];
    let allQuestions = [];
    let currentSearchResults = [];

    function normalizeUnicodeChars(text) {
        if (!text) return '';
        return text.replace(/[iìíîïĩīĭįı]/g, 'і').replace(/[IÌÍÎÏĨĪĬĮI]/g, 'І').replace(/[ёe]/g, 'е').replace(/[Ёe]/g, 'Е').replace(/[ъь]/g, '');
    }

    function normalizeTextForSearch(text) {
        if (!text) return '';
        let normalized = normalizeUnicodeChars(text);
        normalized = normalized.toLowerCase().replace(/[іїи]/g, 'і').replace(/[''''`]/g, "'").replace(/[""""]/g, '"').replace(/\s+/g, ' ').trim();
        return normalized;
    }

    function searchQuestions(searchTerm) {
        if (!searchTerm.trim()) return [];
        const normalizedSearchTerm = normalizeTextForSearch(searchTerm);
        const allSearchWords = normalizedSearchTerm.split(/\s+/).filter(word => word.length > 0);
        const longWords = allSearchWords.filter(word => word.length > 2);
        const shortWords = allSearchWords.filter(word => word.length <= 2);
        
        if (allSearchWords.length === 0) return [];

        const results = [];
        allQuestions.forEach(question => {
            const questionText = normalizeTextForSearch(question._Question || '');
            const helpText = normalizeTextForSearch(question._Help || '');
            const questionWords = questionText.split(/\s+/);
            
            let score = 0;
            const matchedWords = [];

            // Поиск длинных слов (как подстроки)
            longWords.forEach(searchWord => {
                if (questionText.includes(searchWord)) {
                    score += 10;
                    matchedWords.push(searchWord);
                }
                
                questionWords.forEach(word => {
                    if (word.includes(searchWord) && word.length > searchWord.length) {
                        score += 5;
                        if (!matchedWords.includes(searchWord)) {
                            matchedWords.push(searchWord);
                        }
                    }
                });

                if (helpText.includes(searchWord)) {
                    score += 2;
                    if (!matchedWords.includes(searchWord)) {
                        matchedWords.push(searchWord);
                    }
                }
            });

            // Поиск коротких слов (только как целые слова)
            shortWords.forEach(searchWord => {
                if (questionWords.includes(searchWord)) {
                    score += 10;
                    matchedWords.push(searchWord);
                }

                const helpWords = helpText.split(/\s+/);
                if (helpWords.includes(searchWord)) {
                    score += 2;
                    if (!matchedWords.includes(searchWord)) {
                        matchedWords.push(searchWord);
                    }
                }
            });

            if (matchedWords.length === allSearchWords.length) {
                score += 20;
            } else if (matchedWords.length > 0) {
                score += matchedWords.length * 3;
            }

            if (score > 0) {
                results.push({ question: question, score: score, matchedWords: matchedWords });
            }
        });

        return results.sort((a, b) => b.score - a.score);
    }

    function highlightText(text, searchWords) {
        if (!text || !searchWords || searchWords.length === 0) return text;
        
        let result = text;
        searchWords.forEach(word => {
            if (word && word.length > 0) {
                const variants = [
                    word,
                    word.replace(/[iI]/g, (match) => match.toLowerCase() === 'i' ? 'і' : 'І'),
                    word.replace(/[іІ]/g, (match) => match === 'і' ? 'i' : 'I')
                ];
                
                const uniqueVariants = [...new Set(variants)];
                uniqueVariants.forEach(variant => {
                    const escapedVariant = variant.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    
                    // Для коротких слов (1-2 символа) - только целые слова
                    if (variant.length <= 2) {
                        const regex = new RegExp(`\\b(${escapedVariant})\\b`, 'gi');
                        result = result.replace(regex, '<span class="highlight">$1</span>');
                    } else {
                        // Для длинных слов - как обычно
                        const regex = new RegExp(`(${escapedVariant})`, 'gi');
                        result = result.replace(regex, '<span class="highlight">$1</span>');
                    }
                });
            }
        });
        
        return result;
    }

    function displayResults(results, searchTerm) {
        const resultsContainer = document.getElementById('searchResults');
        const resultsCount = document.getElementById('resultsCount');
        
        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <h5>Совпадений не найдено</h5>
                    <p>Попробуйте изменить ключевые слова поиска</p>
                </div>
            `;
            resultsCount.style.display = 'none';
            return;
        }

        resultsCount.innerHTML = `Найдено вопросов: <strong>${results.length}</strong>`;
        resultsCount.style.display = 'block';

        const originalSearchWords = searchTerm.trim().split(/\s+/).filter(word => word.length > 0);
        
        let html = '';
        results.forEach((result, index) => {
            const question = result.question;
            const questionId = question._KodQuestion;
            const questionAnswers = answers.filter(a => a._KodQuestion === questionId);
            const highlightedQuestion = highlightText(question._Question, originalSearchWords);
            
            html += `
                <div class="question-item">
                    <div class="question-text">
                        Вопрос ${index + 1}: ${highlightedQuestion}
                    </div>
                    <div class="answers-section">
            `;
            
            questionAnswers.forEach((answer, answerIndex) => {
                const isCorrect = parseInt(answer._VesAnswer) > 0;
                const answerClass = isCorrect ? 'correct' : 'incorrect';
                const answerLetter = String.fromCharCode(65 + answerIndex);
                
                html += `
                    <div class="answer-item ${answerClass}">
                        <strong>${answerLetter})</strong> ${answer._Answer}
                        ${isCorrect ? '<i class="fas fa-check-circle ms-2"></i>' : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        resultsContainer.innerHTML = html;
    }

    function performSearch() {
        const searchTerm = document.getElementById('searchInput').value.trim();
        if (!searchTerm) {
            clearSearch();
            return;
        }
        
        const results = searchQuestions(searchTerm);
        currentSearchResults = results;
        displayResults(results, searchTerm);
        document.getElementById('clearBtn').style.display = 'block';
    }

    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
        document.getElementById('resultsCount').style.display = 'none';
        document.getElementById('clearBtn').style.display = 'none';
        currentSearchResults = [];
    }

    async function loadQuestionsAndAnswers() {
        try {
            const [questionsResponse, answersResponse] = await Promise.all([
                fetch('Quest3.json'),
                fetch('Answer3.json')
            ]);
            
            if (!questionsResponse.ok || !answersResponse.ok) {
                throw new Error('Ошибка загрузки данных');
            }
            
            const questionsData = await questionsResponse.json();
            const answersData = await answersResponse.json();
            
            allQuestions = questionsData.DATAPACKET.ROWDATA.ROW || [];
            answers = answersData.DATAPACKET.ROWDATA.ROW || [];
            
            try { if (window && window.__QUIET_CONSOLE === false) console.log(`Загружено ${allQuestions.length} вопросов и ${answers.length} ответов`); } catch (e) {}
            
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
            document.getElementById('searchResults').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Ошибка загрузки данных. Пожалуйста, обновите страницу.
                </div>
            `;
        }
    }

    async function init() {
        const crumbs = [
            { label: 'Главная', href: 'index.html' },
            { label: 'Поиск вопросов', href: 'search.html' }
        ];
        
        if (window.uiHelpers) {
            uiHelpers.renderBreadcrumbs('breadcrumbs', crumbs);
            uiHelpers.renderBack('backBtn', 'index.html', 'Назад');
        }
        
        await loadQuestionsAndAnswers();
        
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        searchBtn.addEventListener('click', performSearch);
        clearBtn.addEventListener('click', clearSearch);
        
        searchInput.addEventListener('input', (e) => {
            const clearBtn = document.getElementById('clearBtn');
            if (e.target.value.length > 0) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
                clearSearch();
            }
        });
        
    try { if (window && window.__QUIET_CONSOLE === false) console.log('Страница поиска инициализирована'); } catch (e) {}
    }

    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
